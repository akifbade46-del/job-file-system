<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Job File Management System</title>
<script src="https://cdn.tailwindcss.com">
// --- New Features ---
function sendEmail() {
    generatePrintView();
    const email = prompt("Enter recipient email address:");
    if (email) {
        const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
        const subject = encodeURIComponent("Job File " + jobFileNo);
        const body = encodeURIComponent("Please find the attached Job File PDF.");
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    }
}

function saveData() {
    const data = getFormData();
    localStorage.setItem('jobFileData', JSON.stringify(data));
    alert('Job File saved locally!');
}

function loadData() {
    const data = JSON.parse(localStorage.getItem('jobFileData'));
    if (!data) { alert('No saved data found!'); return; }
    populateFormFromData(data);
    alert('Job File loaded!');
}

function exportExcel() {
    const data = getFormData();
    let csv = 'Field,Value\n';
    for (let key in data) {
        if (typeof data[key] !== 'object') {
            csv += `${key},${data[key]}\n`;
        }
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'jobfile.csv';
    link.click();
}


function newJobEntry() {
    // Clear old AI dashboard & job data
    localStorage.removeItem('jobFileData');
    localStorage.removeItem('jobFileHistory');
    localStorage.removeItem('jobAnalytics');
    
    // Reset all inputs & checkboxes
    document.querySelectorAll('input, textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
    });

    // Reset charges table
    if (typeof populateTable === 'function') populateTable();
    if (typeof calculate === 'function') calculate();

    alert('✅ New job entry started. All old AI dashboard data cleared!');
}


function shareJobFile() {
    const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
    const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
    const text = `Job File: ${jobFileNo}\nDate: ${date}\nGenerated from Q'Go Cargo System.`;

    if (navigator.share) {
        navigator.share({
            title: 'Job File',
            text: text,
            url: window.location.href
        }).catch(console.error);
    } else {
        navigator.clipboard.writeText(text).then(()=>{
            alert('Share text copied to clipboard!');
        });
    }
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js">
// --- New Features ---
function sendEmail() {
    generatePrintView();
    const email = prompt("Enter recipient email address:");
    if (email) {
        const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
        const subject = encodeURIComponent("Job File " + jobFileNo);
        const body = encodeURIComponent("Please find the attached Job File PDF.");
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    }
}

function saveData() {
    const data = getFormData();
    localStorage.setItem('jobFileData', JSON.stringify(data));
    alert('Job File saved locally!');
}

function loadData() {
    const data = JSON.parse(localStorage.getItem('jobFileData'));
    if (!data) { alert('No saved data found!'); return; }
    populateFormFromData(data);
    alert('Job File loaded!');
}

function exportExcel() {
    const data = getFormData();
    let csv = 'Field,Value\n';
    for (let key in data) {
        if (typeof data[key] !== 'object') {
            csv += `${key},${data[key]}\n`;
        }
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'jobfile.csv';
    link.click();
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js">
// --- New Features ---
function sendEmail() {
    generatePrintView();
    const email = prompt("Enter recipient email address:");
    if (email) {
        const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
        const subject = encodeURIComponent("Job File " + jobFileNo);
        const body = encodeURIComponent("Please find the attached Job File PDF.");
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    }
}

function saveData() {
    const data = getFormData();
    localStorage.setItem('jobFileData', JSON.stringify(data));
    alert('Job File saved locally!');
}

function loadData() {
    const data = JSON.parse(localStorage.getItem('jobFileData'));
    if (!data) { alert('No saved data found!'); return; }
    populateFormFromData(data);
    alert('Job File loaded!');
}

function exportExcel() {
    const data = getFormData();
    let csv = 'Field,Value\n';
    for (let key in data) {
        if (typeof data[key] !== 'object') {
            csv += `${key},${data[key]}\n`;
        }
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'jobfile.csv';
    link.click();
}

</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<style>
        :root { --theme-color: #4f46e5; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            border-top: 5px solid var(--theme-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--theme-color);
            box-shadow: 0 0 0 1px var(--theme-color);
        }
        .table-cell {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
        }
        .table-cell input {
            width: 100%;
            border: none;
            padding: 0;
            background-color: transparent;
        }
        .table-cell input:focus {
            outline: none;
        }
        
        /* Modal and Loader Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 0.5rem;
            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--theme-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Print-Specific Styles */
        @page {
            size: A4;
            margin: 0.5cm;
        }
        @media print {
            body { 
                background-color: white !important; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            #main-container, .no-print { display: none !important; }
            #print-output { display: block !important; padding: 0 !important; margin: 0 !important; }
            #qrcode img { width: 96px !important; height: 96px !important; }
        }
        
        /* Styles for the print-friendly output */
        #print-output .print-table { border-collapse: collapse; width: 100%; }
        #print-output .print-table th, #print-output .print-table td {
            border: 1px solid #6b7280;
            padding: 0.3rem;
        }
        #print-output .print-table th { background-color: #f3f4f6; font-weight: 600; }
        #print-output .print-field { border: 1px solid #6b7280; padding: 0.3rem; min-height: 30px; }

        /* Print Templates */
        .template-modern #print-header { background-color: var(--theme-color); color: white; }
        .template-modern .print-table th { background-color: #e0e0e0; }
        .template-minimal .print-table, .template-minimal .print-table th, .template-minimal .print-table td, .template-minimal .print-field { border: 1px solid #e0e0e0; }
        .template-minimal #print-header { border-bottom: 2px solid var(--theme-color); }
    </style>
<style id="print-styles"></style>
<style>
#save-popup {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #10b981;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 9999;
    display: none;
}
</style>
<div id="save-popup">✅ Job File Saved Successfully!</div>
</head>
<body>

<!-- Login Screen -->
<div id="login-screen" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
  <h2>Login</h2>
  <input id="login-username" placeholder="Username" style="margin:5px;padding:5px;">
  <input id="login-password" type="password" placeholder="Password" style="margin:5px;padding:5px;">
  <button onclick="performLogin()">Login</button>
  <div id="login-error" style="color:red;margin-top:10px;"></div>
</div>

<!-- Main Job Dashboard -->
<div id="main-container" style="display:none;">

<div class="container" id="main-container">
<!-- Header Section -->
<header class="flex justify-between items-start mb-6">
<div class="flex items-center">
<div class="text-3xl font-bold mr-4" id="logo-container" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
<h1 class="text-4xl font-bold text-gray-800 border-l-4 border-gray-300 pl-4">JOB FILE</h1>
</div>
<div class="text-right">
<div class="flex items-center mb-2">
<label class="mr-2 font-semibold text-gray-700" for="date">Date:</label>
<input class="input-field w-40" id="date" type="date"/>
</div>
<div class="flex items-center">
<label class="mr-2 font-semibold text-gray-700" for="po-number">P.O. #:</label>
<input class="input-field w-40" id="po-number" type="text"/>
</div>
</div>
</header>
<div class="hidden text-center text-yellow-600 bg-yellow-100 p-2 rounded-md mb-4" id="offline-message">
            You are offline. AI features are running in a limited, offline mode.
        </div>
<!-- Top Form Section -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div class="lg:col-span-2">
<label class="block mb-1 font-semibold text-gray-700" for="job-file-no">Job File No.:</label>
<input class="input-field" id="job-file-no" type="text"/>
</div>
<div>
<label class="block mb-1 font-semibold text-gray-700" for="type">Type:</label>
<input class="input-field" id="type" type="text"/>
</div>
<div class="flex space-x-6">
<div>
<span class="font-semibold text-gray-700">Clearance</span>
<div class="mt-2 space-y-1">
<label class="flex items-center"><input class="mr-2" data-clearance="Export" type="checkbox"/> Export</label>
<label class="flex items-center"><input class="mr-2" data-clearance="Import" type="checkbox"/> Import</label>
<label class="flex items-center"><input class="mr-2" data-clearance="Clearance" type="checkbox"/> Clearance</label>
<label class="flex items-center"><input class="mr-2" data-clearance="Local Move" type="checkbox"/> Local Move</label>
</div>
</div>
<div>
<span class="font-semibold text-gray-700">Product Type</span>
<div class="mt-2 space-y-1">
<label class="flex items-center"><input class="mr-2" data-product="Air Freight" type="checkbox"/> Air Freight</label>
<label class="flex items-center"><input class="mr-2" data-product="Sea Freight" type="checkbox"/> Sea Freight</label>
<label class="flex items-center"><input class="mr-2" data-product="Land Freight" type="checkbox"/> Land Freight</label>
<label class="flex items-center"><input class="mr-2" data-product="Others" type="checkbox"/> Others</label>
</div>
</div>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
<div><label class="block mb-1 font-semibold text-gray-700" for="invoice-no">Invoice No.:</label><input class="input-field" id="invoice-no" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="billing-date">Billing Date:</label><input class="input-field" id="billing-date" type="date"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="salesman">Salesman:</label><input class="input-field" id="salesman" type="text"/></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
<div><label class="block mb-1 font-semibold text-gray-700" for="shipper-name">Shipper's Name:</label><input class="input-field" id="shipper-name" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="consignee-name">Consignee's Name:</label><input class="input-field" id="consignee-name" type="text"/></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
<div><label class="block mb-1 font-semibold text-gray-700" for="mawb">MAWB / OBL / TCN No.:</label><input class="input-field" id="mawb" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="hawb">HAWB / HBL:</label><input class="input-field" id="hawb" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="teams-of-shipping">Teams of Shipping:</label><input class="input-field" id="teams-of-shipping" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="origin">Origin:</label><input class="input-field" id="origin" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="no-of-pieces">No. of Pieces:</label><input class="input-field" id="no-of-pieces" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="gross-weight">Gross Weight:</label><input class="input-field" id="gross-weight" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="destination">Destination:</label><input class="input-field" id="destination" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="volume-weight">Volume Weight:</label><input class="input-field" id="volume-weight" type="text"/></div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
<div class="lg:col-span-2"><label class="block mb-1 font-semibold text-gray-700" for="description">Description:</label><input class="input-field" id="description" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="carrier">Carrier / Shipping Line / Trucking Co:</label><input class="input-field" id="carrier" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="truck-no">Truck No. / Driver's Name:</label><input class="input-field" id="truck-no" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="vessel-name">Vessel's Name:</label><input class="input-field" id="vessel-name" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="flight-voyage-no">Flight / Voyage No.:</label><input class="input-field" id="flight-voyage-no" type="text"/></div>
<div><label class="block mb-1 font-semibold text-gray-700" for="container-no">Container No.:</label><input class="input-field" id="container-no" type="text"/></div>
</div>
<!-- Charges Table -->
<div class="flex justify-between items-center mb-2">
<h2 class="text-xl font-semibold text-gray-800">Charges</h2>
<button class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 no-print" id="analyze-costs-btn" onclick="analyzeCosts()">
                ✨ Analyze Costs
            </button>
</div>
<div class="mb-6">
<table class="w-full border-collapse">
<thead><tr class="bg-gray-100"><th class="table-cell font-semibold w-2/5">Description</th><th class="table-cell font-semibold">Cost</th><th class="table-cell font-semibold">Selling</th><th class="table-cell font-semibold">Profit</th><th class="table-cell font-semibold">Notes</th></tr></thead>
<tbody id="charges-table-body"></tbody>
</table>
</div>
<!-- Remarks Section -->
<div class="mb-8">
<div class="flex justify-between items-center mb-2"><label class="block font-semibold text-gray-700" for="remarks">REMARKS:</label><button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 no-print" id="generate-remarks-btn" onclick="generateRemarks()">✨ Generate Remarks</button></div>
<textarea class="input-field w-full" id="remarks" rows="4"></textarea>
</div>
<!-- Footer Section -->
<footer class="grid grid-cols-1 md:grid-cols-3 gap-8 pt-6 border-t">
<div><label class="block mb-2 font-semibold text-gray-700">PREPARED BY</label><input class="input-field" id="prepared-by" type="text"/></div>
<div><label class="block mb-2 font-semibold text-gray-700">CHECKED BY</label><input class="input-field" id="checked-by" type="text"/></div>
<div><label class="block mb-2 font-semibold text-gray-700">APPROVED BY</label><input class="input-field" id="approved-by" type="text"/></div>
</footer>
<!-- Action Buttons -->
<div class="text-center mt-10 no-print space-x-4">
<button class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="openAboutModal()">About</button>
<button class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="newJobEntry()">New Job</button>
<button class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="openERPModal()">ERP System</button>
<button class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="openSettingsModal()">Settings</button>
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="saveData()">Save</button>
<button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="loadData()">Load</button>
<button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="exportExcel()">Export Excel</button>
<button class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="previewPage()">Preview</button>
<button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105" onclick="printPage()">Print Job File</button>
</div>
</div>
<!-- This container is hidden by default and will be populated for printing/preview -->
<div class="hidden" id="print-output"></div>
<!-- Modals -->
<div class="modal-overlay hidden" id="ai-modal"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">✨ Cost Analysis</h3><button class="text-gray-500 hover:text-gray-800 text-2xl" onclick="closeModal()">×</button></div><div id="modal-body"></div></div></div>
<div class="modal-overlay hidden" id="settings-modal"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Settings</h3><button class="text-gray-500 hover:text-gray-800 text-2xl" onclick="closeSettingsModal()">×</button></div><div class="space-y-4"><div><label class="block mb-2" for="theme-color-picker">Theme Color:</label><input class="input-field" id="theme-color-picker" type="color"/></div><div><label class="block mb-2" for="print-template-select">Print Template:</label><select class="input-field" id="print-template-select"><option value="classic">Classic</option><option value="modern">Modern</option><option value="minimal">Minimalist</option></select></div><div><label class="block mb-2" for="font-size-slider">Form Font Size:</label><div class="flex items-center"><input class="w-full" id="font-size-slider" max="24" min="12" type="range"/><span class="ml-4 w-12 text-center" id="font-size-value"></span></div></div><div><label class="block mb-2" for="print-font-size-slider">Print/PDF Font Size:</label><div class="flex items-center"><input class="w-full" id="print-font-size-slider" max="18" min="8" type="range"/><span class="ml-4 w-12 text-center" id="print-font-size-value"></span></div></div><div><label class="block mb-2" for="print-scale-slider">Print Scale:</label><div class="flex items-center"><input class="w-full" id="print-scale-slider" max="100" min="70" type="range"/><span class="ml-4 w-12 text-center" id="print-scale-value"></span></div></div><div><label class="block mb-2" for="logo-size-slider">Logo Size:</label><div class="flex items-center"><input class="w-full" id="logo-size-slider" max="6" min="2" step="0.5" type="range"/><span class="ml-4 w-12 text-center" id="logo-size-value"></span></div></div><div><label class="flex items-center justify-between"><span>Show QR Code on Print/PDF</span><input class="h-6 w-6" id="show-qr-toggle" type="checkbox"/></label></div><div><label class="block mb-2" for="default-prepared-by">Default "Prepared By" Name:</label><input class="input-field" id="default-prepared-by" type="text"/></div><div class="text-right"><button class="bg-blue-500 text-white py-2 px-4 rounded" onclick="saveSettings()">Save Settings</button></div></div></div></div>
<div class="modal-overlay hidden" id="about-modal"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">About this Application</h3><button class="text-gray-500 hover:text-gray-800 text-2xl" onclick="closeAboutModal()">×</button></div><div class="space-y-4 text-sm"><p class="text-center font-bold">Made by Akif Arif Bade for Q'go Cargo</p><div><h4 class="font-bold mb-1">How to Use:</h4><ol class="list-decimal list-inside space-y-1"><li>Fill in all the job details in the form.</li><li>Use the AI features (internet required) to generate remarks and analyze costs.</li><li>Click "Preview" to see a print-friendly version of your job file.</li><li>Click "Save as PDF" from the preview screen to download the file.</li><li>Use the "Settings" panel to customize the application to your liking.</li></ol></div><div><h4 class="font-bold mb-1">Key Features:</h4><ul class="list-disc list-inside space-y-1"><li>Automatic profit calculation.</li><li>AI-powered remarks and cost analysis (online).</li><li>Offline-first functionality for core features.</li><li>Customizable settings that are saved to your browser.</li><li>English and Arabic language support.</li><li>Print-friendly layout with scannable QR code for verification.</li></ul></div></div></div></div>
<div class="modal-overlay hidden" id="loader-overlay"><div class="loader"></div></div>
<script>
        // --- Gemini API Call Function ---
        async function callGemini(prompt) {
            if (window.location.protocol === 'file:') {
                showModal(`<p class="text-red-500">AI features are not available when running the file locally. Please host this file on a web server to enable AI functionality.</p>`);
                return "Error: Local file access";
            }
            const apiKey = ""; // Provided by Canvas
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) {
                    showModal(`<p class="text-red-500">Error: Could not connect to the AI service. Please check your internet connection and try again.</p>`);
                    throw new Error(`API call failed: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not parse AI response.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showModal(`<p class="text-red-500">Error: Could not connect to the AI service. Please check your internet connection and try again.</p>`);
                return `Error: ${error.message}`;
            }
        }

        // --- AI Feature Functions ---
        async function generateRemarks() {
            showLoader();
            const data = getFormData();
            const prompt = `Generate a concise, professional remark for a logistics job file with these details: Job Description: ${data.dsc}, Shipper: ${data.sh}, Consignee: ${data.co}, Origin: ${data.or}, Destination: ${data.de}. Generate only the remark text.`;
            const remarksText = await callGemini(prompt);
            if (!remarksText.startsWith("Error:")) {
                document.getElementById('remarks').value = remarksText;
            }
            hideLoader();
        }

        async function analyzeCosts() {
            showLoader();
            const data = getFormData();
            if (data.ch.length === 0) {
                showModal("Please enter some costs before analyzing.");
                hideLoader();
                return;
            }
            const costBreakdown = data.ch.map(c => `- ${c.l} $${c.c}`).join('\n');
            const prompt = `As a logistics cost analyst, review this cost breakdown for a ${data.pt.join(', ')} shipment:\n${costBreakdown}\nProvide a brief analysis identifying unusual costs and suggesting savings. Format as simple HTML paragraphs.`;
            const analysisHtml = await callGemini(prompt);
             if (!analysisHtml.startsWith("Error:")) {
                showModal(analysisHtml);
            }
            hideLoader();
        }

        // --- Data Handling ---
        function getFormData() {
            const getVal = id => document.getElementById(id).value || '';
            const getChecked = query => Array.from(document.querySelectorAll(query)).filter(el => el.checked).map(el => el.dataset.clearance || el.dataset.product);

            const charges = [];
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                if (row.id === 'total-row') return;
                charges.push({
                    l: row.cells[0].textContent.trim(), // label
                    c: row.querySelector('.cost-input').value || '0', // cost
                    s: row.querySelector('.selling-input').value || '0', // selling
                    n: row.cells[4].querySelector('input').value || '' // notes
                });
            });

            return {
                d: getVal('date'), po: getVal('po-number'), jfn: getVal('job-file-no'), t: getVal('type'),
                cl: getChecked('[data-clearance]:checked'), pt: getChecked('[data-product]:checked'),
                in: getVal('invoice-no'), bd: getVal('billing-date'), sm: getVal('salesman'),
                sh: getVal('shipper-name'), co: getVal('consignee-name'),
                mawb: getVal('mawb'), hawb: getVal('hawb'), ts: getVal('teams-of-shipping'), or: getVal('origin'),
                pc: getVal('no-of-pieces'), gw: getVal('gross-weight'), de: getVal('destination'), vw: getVal('volume-weight'),
                dsc: getVal('description'), ca: getVal('carrier'), tn: getVal('truck-no'),
                vn: getVal('vessel-name'), fv: getVal('flight-voyage-no'), cn: getVal('container-no'),
                ch: charges,
                re: getVal('remarks'),
                pb: getVal('prepared-by'), cb: getVal('checked-by'), ab: getVal('approved-by'),
            };
        }

        function populateFormFromData(data) {
            const setVal = (id, value) => { if (document.getElementById(id)) document.getElementById(id).value = value || ''; };
            const setChecked = (type, values) => {
                document.querySelectorAll(`[data-${type}]`).forEach(el => {
                    el.checked = values.includes(el.dataset[type]);
                });
            };

            setVal('date', data.d); setVal('po-number', data.po); setVal('job-file-no', data.jfn);
            setVal('type', data.t); setVal('invoice-no', data.in); setVal('billing-date', data.bd);
            setVal('salesman', data.sm); setVal('shipper-name', data.sh); setVal('consignee-name', data.co);
            setVal('mawb', data.mawb); setVal('hawb', data.hawb); setVal('teams-of-shipping', data.ts);
            setVal('origin', data.or); setVal('no-of-pieces', data.pc); setVal('gross-weight', data.gw);
            setVal('destination', data.de); setVal('volume-weight', data.vw); setVal('description', data.dsc);
            setVal('carrier', data.ca); setVal('truck-no', data.tn); setVal('vessel-name', data.vn);
            setVal('flight-voyage-no', data.fv); setVal('container-no', data.cn);
            setVal('remarks', data.re); setVal('prepared-by', data.pb); setVal('checked-by', data.cb);
            setVal('approved-by', data.ab);

            setChecked('clearance', data.cl || []);
            setChecked('product', data.pt || []);

            if (data.ch) {
                const rows = document.querySelectorAll('#charges-table-body tr');
                rows.forEach((row, index) => {
                    if (index < data.ch.length) {
                        const chargeData = data.ch[index];
                        row.querySelector('.cost-input').value = chargeData.c;
                        row.querySelector('.selling-input').value = chargeData.s;
                        row.querySelector('input[type="text"]:not([class])').value = chargeData.n;
                    }
                });
            }
            calculate();
        }

        // --- Print, Preview, and PDF Logic ---
        function generatePrintView() {
            const data = getFormData();
            const settings = loadSettings();
            const totals = {
                cost: document.getElementById('total-cost').textContent,
                selling: document.getElementById('total-selling').textContent,
                profit: document.getElementById('total-profit').textContent,
            };
            const checkedSymbol = '☑';
            const uncheckedSymbol = '☐';
            const printHTML = `
                <div class="p-4">
                    
<div class="no-print text-center mb-4">
    <button onclick="previewPage()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">Back</button>
    <button onclick="saveAsPdf()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Save PDF</button>
    <button onclick="sendEmail()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Send Email</button>
    <button onclick="shareJobFile()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">Share</button>
</div>

                    <div class="border border-gray-700 p-2">
                        <div class="grid grid-cols-12 gap-px bg-gray-700" style="border: 1px solid #374151;">
                            <div class="col-span-3 bg-white p-1 flex items-center" style="border: 1px solid #374151;">
                                <div id="print-logo-container" class="text-xl font-bold" style="color: #0E639C;">Q'go<span style="color: #4FB8AF;">Cargo</span></div>
                            </div>
                            <div class="col-span-6 bg-white flex items-center justify-center text-xl font-bold" style="border: 1px solid #374151;">JOB FILE</div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><div><strong>Date:</strong> ${data.d}</div><div><strong>P.O. #:</strong> ${data.po}</div></div>
                            
                            <div class="col-span-8 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Job File No.:</strong> ${data.jfn}</div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Type:</strong> ${data.t}</div>

                            <div class="col-span-12 bg-white p-1 grid grid-cols-4 gap-2 text-xs" style="border: 1px solid #374151;">
                                <div><strong>Clearance</strong><br>${data.cl.includes('Export') ? checkedSymbol : uncheckedSymbol} Export<br>${data.cl.includes('Import') ? checkedSymbol : uncheckedSymbol} Import<br>${data.cl.includes('Clearance') ? checkedSymbol : uncheckedSymbol} Clearance<br>${data.cl.includes('Local Move') ? checkedSymbol : uncheckedSymbol} Local Move</div>
                                <div><strong>Product Type</strong><br>${data.pt.includes('Air Freight') ? checkedSymbol : uncheckedSymbol} Air<br>${data.pt.includes('Sea Freight') ? checkedSymbol : uncheckedSymbol} Sea<br>${data.pt.includes('Land Freight') ? checkedSymbol : uncheckedSymbol} Land<br>${data.pt.includes('Others') ? checkedSymbol : uncheckedSymbol} Others</div>
                                <div class="col-span-2"></div>
                            </div>

                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Invoice No.:</strong> ${data.in}</div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Billing Date:</strong> ${data.bd}</div>
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Salesman:</strong> ${data.sm}</div>

                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Shipper's Name:</strong><div class="print-field">${data.sh}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Consignee's Name:</strong><div class="print-field">${data.co}</div></div>
                            
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>MAWB/OBL/TCN:</strong><div class="print-field">${data.mawb}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Teams of Shipping:</strong><div class="print-field">${data.ts}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>HAWB/HBL:</strong><div class="print-field">${data.hawb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Origin:</strong><div class="print-field">${data.or}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Destination:</strong><div class="print-field">${data.de}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>No. of Pieces:</strong><div class="print-field">${data.pc}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Gross Wt:</strong><div class="print-field">${data.gw}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Volume Wt:</strong><div class="print-field">${data.vw}</div></div>
                            
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Description:</strong><div class="print-field">${data.dsc}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Carrier/Line/Trucking:</strong><div class="print-field">${data.ca}</div></div>
                            <div class="col-span-6 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Truck/Driver:</strong><div class="print-field">${data.tn}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Vessel:</strong><div class="print-field">${data.vn}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Flight/Voyage:</strong><div class="print-field">${data.fv}</div></div>
                            <div class="col-span-4 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>Container No:</strong><div class="print-field">${data.cn}</div></div>

                            <div class="col-span-12 bg-white p-0" style="border: 1px solid #374151;">
                                <table class="print-table">
                                    <thead><tr><th>Description</th><th>Cost</th><th>Selling</th><th>Profit</th><th>Notes</th></tr></thead>
                                    <tbody>
                                        ${data.ch.map(c => `<tr><td>${c.l}</td><td>${c.c}</td><td>${c.s}</td><td>${(parseFloat(c.s) - parseFloat(c.c)).toFixed(2)}</td><td>${c.n}</td></tr>`).join('')}
                                        <tr class="font-bold bg-gray-100"><td>TOTAL:</td><td>${totals.cost}</td><td>${totals.selling}</td><td>${totals.profit}</td><td></td></tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="col-span-12 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>REMARKS:</strong><div class="print-field h-20">${data.re.replace(/\n/g, '<br>')}</div></div>
                            
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>PREPARED BY:</strong><div class="print-field">${data.pb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>CHECKED BY:</strong><div class="print-field">${data.cb}</div></div>
                            <div class="col-span-3 bg-white p-1 text-xs" style="border: 1px solid #374151;"><strong>APPROVED BY:</strong><div class="print-field">${data.ab}</div></div>
                            <div class="col-span-3 bg-white p-1 flex items-center justify-center" style="border: 1px solid #374151;"><div id="qrcode"></div></div>
                        </div>
                    </div>
                </div>
            `;
            const printContainer = document.getElementById('print-output');
            printContainer.innerHTML = printHTML;
            applyLogoSize(settings.logoSize); // Apply logo size to print view

            if (settings.showQRCode) {
                const qrText = `JobFile No: ${data.jfn}\nDate: ${data.d}\nShipper: ${data.sh}\nConsignee: ${data.co}`;
                
                const qrCodeContainer = printContainer.querySelector('#qrcode');
                qrCodeContainer.innerHTML = "";
                new QRCode(qrCodeContainer, {
                    text: qrText,
                    width: 128,
                    height: 128,
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function previewPage() {
            const mainContainer = document.getElementById('main-container');
            const printContainer = document.getElementById('print-output');
            
            if (mainContainer.classList.contains('hidden')) {
                mainContainer.classList.remove('hidden');
                printContainer.classList.add('hidden');
            } else {
                generatePrintView();
                mainContainer.classList.add('hidden');
                printContainer.classList.remove('hidden');
            }
        }
        
        function saveAsPdf() {
            showLoader();
            generatePrintView();
            const element = document.getElementById('print-output').querySelector('.border');
            const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
            const date = document.getElementById('date').value || new Date().toISOString().slice(0,10);
            const opt = {
              margin:       0.2,
              filename:     `${jobFileNo}_${date}.pdf`,
              image:        { type: 'jpeg', quality: 1.0 },
              html2canvas:  { scale: 3 },
              jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            setTimeout(() => {
                html2pdf().from(element).set(opt).save().then(hideLoader);
            }, 500);
        }

        function printPage() {
            generatePrintView();
            setTimeout(() => { window.print(); }, 500);
        }

        // --- UI Functions ---
        function showLoader() { document.getElementById('loader-overlay').classList.remove('hidden'); }
        function hideLoader() { document.getElementById('loader-overlay').classList.add('hidden'); }
        function showModal(content) { document.getElementById('modal-body').innerHTML = content; document.getElementById('ai-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('ai-modal').classList.add('hidden'); }
        function openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
        function openAboutModal() { document.getElementById('about-modal').classList.remove('hidden'); }
        function closeAboutModal() { document.getElementById('about-modal').classList.add('hidden'); }
        
        function applyFontSize(value) {
            document.getElementById('main-container').style.fontSize = `${value}px`;
            document.getElementById('font-size-value').textContent = `${value}px`;
        }

        function applyPrintFontSize(value) {
            const styleTag = document.getElementById('print-styles');
            styleTag.innerHTML = `
                #print-output { font-size: ${value}px; }
                #print-output .print-table th, #print-output .print-table td { font-size: ${parseInt(value) - 1}px; }
                #print-output .text-xl { font-size: ${parseInt(value) + 4}px; }
                #print-output .text-xs { font-size: ${parseInt(value) - 2}px; }
            `;
            document.getElementById('print-font-size-value').textContent = `${value}px`;
        }
        
        function applyLogoSize(value) {
            const sizeInRem = value;
            document.getElementById('logo-container').style.fontSize = `${sizeInRem * 0.75}rem`;
            if(document.getElementById('print-logo-container')) {
                document.getElementById('print-logo-container').style.fontSize = `${sizeInRem * 0.5}rem`;
            }
            document.getElementById('logo-size-value').textContent = `${sizeInRem}rem`;
        }

        function saveSettings() {
            const settings = {
                formFontSize: document.getElementById('font-size-slider').value,
                printFontSize: document.getElementById('print-font-size-slider').value,
                logoSize: document.getElementById('logo-size-slider').value,
                showQRCode: document.getElementById('show-qr-toggle').checked,
                preparedBy: document.getElementById('default-prepared-by').value,
                themeColor: document.getElementById('theme-color-picker').value,
                printTemplate: document.getElementById('print-template-select').value,
                printScale: document.getElementById('print-scale-slider').value
            };
            localStorage.setItem('jobFileSettings', JSON.stringify(settings));
            closeSettingsModal();
            applySettings(settings);
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('jobFileSettings')) || {
                formFontSize: 16,
                printFontSize: 10,
                logoSize: 3,
                showQRCode: true,
                preparedBy: '',
                themeColor: '#4f46e5',
                printTemplate: 'classic',
                printScale: 100
            };
            
            document.getElementById('font-size-slider').value = settings.formFontSize;
            document.getElementById('print-font-size-slider').value = settings.printFontSize;
            document.getElementById('logo-size-slider').value = settings.logoSize;
            document.getElementById('show-qr-toggle').checked = settings.showQRCode;
            document.getElementById('default-prepared-by').value = settings.preparedBy;
            document.getElementById('prepared-by').value = settings.preparedBy;
            document.getElementById('theme-color-picker').value = settings.themeColor;
            document.getElementById('print-template-select').value = settings.printTemplate;
            document.getElementById('print-scale-slider').value = settings.printScale;
            
            applySettings(settings);
            return settings;
        }

        function applySettings(settings) {
            applyFontSize(settings.formFontSize);
            applyPrintFontSize(settings.printFontSize);
            applyLogoSize(settings.logoSize);
            document.documentElement.style.setProperty('--theme-color', settings.themeColor);
        }


        // --- Calculation and Table Population ---
        function calculate() {
            let totalCost = 0, totalSelling = 0, totalProfit = 0;
            document.querySelectorAll('#charges-table-body tr').forEach(row => {
                if (row.id === 'total-row') return;
                const cost = parseFloat(row.querySelector('.cost-input').value) || 0;
                const selling = parseFloat(row.querySelector('.selling-input').value) || 0;
                const profit = selling - cost;
                row.cells[3].textContent = profit.toFixed(2);
                row.cells[3].className = 'table-cell profit-output bg-gray-50';
                if (profit < 0) row.cells[3].classList.add('text-red-600');
                else if (profit > 0) row.cells[3].classList.add('text-green-600');
                totalCost += cost; totalSelling += selling; totalProfit += profit;
            });
            document.getElementById('total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('total-selling').textContent = totalSelling.toFixed(2);
            const totalProfitCell = document.getElementById('total-profit');
            totalProfitCell.textContent = totalProfit.toFixed(2);
            totalProfitCell.className = 'table-cell';
            if (totalProfit < 0) totalProfitCell.classList.add('text-red-600');
            else if (totalProfit > 0) totalProfitCell.classList.add('text-green-600');
        }
        
        function populateTable() {
            const chargeKeys = ["Ex-works Charges:", "Land/Air / Sea Freight:", "Fuell Security / War Surcharge:", "Formalities:", "Delivery Order Fee:", "Transportation Charges:", "Inspection / Computer Print Charges:", "Handling Charges:", "Labor / Forklift Charges:", "Documentation Charges:", "Clearance Charges:", "Customs Duty:", "Terminal Handling Charges:", "Legalization Charges:", "Demurrage Charges:", "Loading / Offloading Charges:", "Destination Clearance Charges:", "Packing Charges:", "Port Charges:", "Other Charges:", "PAI Approval :", "Insurance Fee :", "EPA Charges :"];
            const tableBody = document.getElementById('charges-table-body');
            let rowsHtml = chargeKeys.map(key => `<tr><td class="table-cell font-medium text-gray-700" data-translate-key="${key}">${key}</td><td class="table-cell"><input type="text" class="cost-input"></td><td class="table-cell"><input type="text" class="selling-input"></td><td class="table-cell profit-output bg-gray-50"></td><td class="table-cell"><input type="text"></td></tr>`).join('');
            rowsHtml += `<tr id="total-row" class="bg-gray-100 font-bold"><td class="table-cell text-right" data-translate-key="total">TOTAL:</td><td id="total-cost" class="table-cell"></td><td id="total-selling" class="table-cell"></td><td id="total-profit" class="table-cell"></td><td class="table-cell"></td></tr>`;
            tableBody.innerHTML = rowsHtml;
        }
        
        function setupEventListeners() {
            document.getElementById('charges-table-body').addEventListener('input', e => {
                if (e.target.classList.contains('cost-input') || e.target.classList.contains('selling-input')) {
                    calculate();
                }
            });
            document.getElementById('font-size-slider').addEventListener('input', e => applyFontSize(e.target.value));
            document.getElementById('print-font-size-slider').addEventListener('input', e => applyPrintFontSize(e.target.value));
            document.getElementById('logo-size-slider').addEventListener('input', e => applyLogoSize(e.target.value));
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateTable();
            setupEventListeners();
            calculate();
            loadSettings();
        });
    
// --- New Features ---
function sendEmail() {
    generatePrintView();
    const email = prompt("Enter recipient email address:");
    if (email) {
        const jobFileNo = document.getElementById('job-file-no').value || 'JobFile';
        const subject = encodeURIComponent("Job File " + jobFileNo);
        const body = encodeURIComponent("Please find the attached Job File PDF.");
        window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    }
}

function saveData() {
    const data = getFormData();
    localStorage.setItem('jobFileData', JSON.stringify(data));
    alert('Job File saved locally!');
}

function loadData() {
    const data = JSON.parse(localStorage.getItem('jobFileData'));
    if (!data) { alert('No saved data found!'); return; }
    populateFormFromData(data);
    alert('Job File loaded!');
}

function exportExcel() {
    const data = getFormData();
    let csv = 'Field,Value\n';
    for (let key in data) {
        if (typeof data[key] !== 'object') {
            csv += `${key},${data[key]}\n`;
        }
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'jobfile.csv';
    link.click();
}

</script>
<!-- === FULL OFFLINE AI ENGINE START === -->
<script>
</script>
<!-- === FULL OFFLINE AI ENGINE END === -->
<!-- === OFFLINE TRANSLATION & CURRENCY CONVERTER START === -->
<script>
// === Offline Translation Dictionary (English ↔ Arabic common logistics terms) ===
const translationDict = {
  "Shipper": "الشاحن",
  "Consignee": "المستلم",
  "Origin": "المنشأ",
  "Destination": "الوجهة",
  "Invoice": "فاتورة",
  "Cargo": "البضائع",
  "Freight": "الشحن",
  "Delivery": "التسليم",
  "Customs": "الجمارك",
  "Clearance": "التخليص"
};

function offlineTranslateToArabic(text) {
  return translationDict[text] || text;
}
function offlineTranslateToEnglish(text) {
  const eng = Object.keys(translationDict).find(k => translationDict[k] === text);
  return eng || text;
}

// === Offline Currency Converter with static rates ===
const currencyRates = {
  "USD": 1,
  "KWD": 0.31,
  "EUR": 0.92,
  "INR": 83.2,
  "PHP": 58.5
};

function convertCurrency(amount, from, to) {
  if (!currencyRates[from] || !currencyRates[to]) return amount;
  const usdValue = amount / currencyRates[from];
  return (usdValue * currencyRates[to]).toFixed(2);
}

// Example usage hook for currency conversion in cost analysis
function offlineAnalyzeCosts() {
  showLoader();
  const data = getFormData();
  let totalProfit = 0;
  data.ch.forEach(c => { totalProfit += (parseFloat(c.s||0) - parseFloat(c.c||0)); });
  let suggestion = "";
  if (totalProfit < 0) suggestion = "⚠️ Loss detected. Review costs urgently.";
  else if (totalProfit < 100) suggestion = "⚠️ Low margin. Optimize pricing.";
  else suggestion = "✅ Healthy profit margin maintained.";
  const totalProfitKWD = convertCurrency(totalProfit, "USD", "KWD");
  const html = `<p><strong>Total Profit:</strong> $${totalProfit.toFixed(2)} (≈ KWD ${totalProfitKWD})</p><p>${suggestion}</p>`;
  showModal(html);
  hideLoader();
}
</script>
<!-- === OFFLINE TRANSLATION & CURRENCY CONVERTER END === -->
<!-- === OFFLINE AI UI INTEGRATION START === -->
<script>
// === Add UI buttons dynamically ===
document.addEventListener('DOMContentLoaded', () => {
  // Add Translate buttons under Remarks
  const remarksBox = document.getElementById('remarks');
  if (remarksBox) {
    const btnContainer = document.createElement('div');
    btnContainer.className = 'flex space-x-2 mt-2';
    btnContainer.innerHTML = `
      <button onclick="translateRemarksToArabic()" class="bg-green-500 text-white px-3 py-1 rounded">Translate to Arabic</button>
      <button onclick="translateRemarksToEnglish()" class="bg-blue-500 text-white px-3 py-1 rounded">Translate to English</button>`;
    remarksBox.parentNode.appendChild(btnContainer);
  }

  // Add Currency Converter button near Charges Table
  const chargesTable = document.getElementById('charges-table-body');
  if (chargesTable) {
    const convBtn = document.createElement('button');
    convBtn.textContent = "💱 Currency Converter";
    convBtn.className = "bg-purple-500 text-white px-4 py-2 rounded mt-2";
    convBtn.onclick = openCurrencyConverter;
    chargesTable.parentNode.appendChild(convBtn);
  }

  // Add AI Dashboard button to footer
  const footer = document.querySelector('footer') || document.body;
  const dashBtn = document.createElement('button');
  dashBtn.textContent = "📊 Open AI Dashboard";
  dashBtn.className = "bg-teal-600 text-white px-4 py-2 rounded mt-4";
  dashBtn.onclick = openAIDashboard;
  footer.appendChild(dashBtn);

  // Add Backup/Restore buttons to settings modal
  const settingsModal = document.getElementById('settings-modal').querySelector('.space-y-4');
  const backupDiv = document.createElement('div');
  backupDiv.innerHTML = `
    <h4 class="font-bold mb-2">Backup & Restore</h4>
    <button onclick="backupJobs()" class="bg-indigo-500 text-white px-3 py-1 rounded">Backup Jobs</button>
    <input type="file" id="restore-file" class="mt-2" onchange="restoreJobs(this)">
  `;
  settingsModal.appendChild(backupDiv);

  // Add Health Meter bar on top
  const container = document.getElementById('main-container') || document.body;
  const healthBar = document.createElement('div');
  healthBar.id = "health-meter";
  healthBar.style.height = "8px";
  healthBar.style.background = "#e5e7eb";
  healthBar.style.marginBottom = "10px";
  const fill = document.createElement('div');
  fill.id = "health-fill";
  fill.style.height = "8px";
  fill.style.width = "0%";
  fill.style.background = "#10b981";
  healthBar.appendChild(fill);
  container.insertBefore(healthBar, container.firstChild);

  document.querySelectorAll('input,textarea').forEach(el => el.addEventListener('input', updateHealthMeter));
  updateHealthMeter();
});

// === Offline Translation Buttons Logic ===
function translateRemarksToArabic() {
  const box = document.getElementById('remarks');
  box.value = box.value.split(' ').map(offlineTranslateToArabic).join(' ');
}
function translateRemarksToEnglish() {
  const box = document.getElementById('remarks');
  box.value = box.value.split(' ').map(offlineTranslateToEnglish).join(' ');
}

// === Currency Converter Panel ===
function openCurrencyConverter() {
  const html = `
    <h3 class='font-bold mb-2'>💱 Offline Currency Converter</h3>
    <label>Amount: <input type='number' id='conv-amount' value='100'></label>
    <label>From: 
      <select id='conv-from'>
        <option>USD</option><option>KWD</option><option>EUR</option><option>INR</option><option>PHP</option>
      </select>
    </label>
    <label>To: 
      <select id='conv-to'>
        <option>KWD</option><option>USD</option><option>EUR</option><option>INR</option><option>PHP</option>
      </select>
    </label>
    <button onclick='doConvert()' class='bg-green-500 text-white px-3 py-1 rounded mt-2'>Convert</button>
    <div id='conv-result' class='mt-2 font-bold'></div>
  `;
  showModal(html);
}
function doConvert() {
  const amt = parseFloat(document.getElementById('conv-amount').value);
  const from = document.getElementById('conv-from').value;
  const to = document.getElementById('conv-to').value;
  const res = convertCurrency(amt, from, to);
  document.getElementById('conv-result').textContent = `≈ ${res} ${to}`;
}

// === Backup & Restore Logic ===
function backupJobs() {
  const jobs = localStorage.getItem('jobFileHistory') || '[]';
  const blob = new Blob([jobs], {type:'application/json'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'job_backup.json';
  link.click();
}
function restoreJobs(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    localStorage.setItem('jobFileHistory', e.target.result);
    alert('Jobs restored successfully!');
  };
  reader.readAsText(file);
}

// === Health Meter Logic ===
function updateHealthMeter() {
  const inputs = Array.from(document.querySelectorAll('input,textarea')).filter(i=>i.type!=='checkbox' && i.id!=='restore-file');
  const filled = inputs.filter(i=>i.value.trim()!=='').length;
  const percent = Math.round((filled / inputs.length) * 100);
  document.getElementById('health-fill').style.width = percent + '%';
}
</script>
<!-- === OFFLINE AI UI INTEGRATION END === -->
<!-- === SMART AUTO-FILL & MEMORY SYSTEM START === -->
<script>
// Memory system: save and suggest shipper/consignee based on past jobs

// Add suggestion dropdowns to shipper & consignee inputs
document.addEventListener('DOMContentLoaded', () => {
  const shipperInput = document.getElementById('shipper-name') || document.getElementById('shipper');
  const consigneeInput = document.getElementById('consignee-name') || document.getElementById('consignee');
  if (shipperInput) attachSuggestions(shipperInput, 'shipper');
  if (consigneeInput) attachSuggestions(consigneeInput, 'consignee');
});

function attachSuggestions(input, type) {
  const suggestionBox = document.createElement('div');
  suggestionBox.style.position = 'absolute';
  suggestionBox.style.background = '#fff';
  suggestionBox.style.border = '1px solid #ccc';
  suggestionBox.style.zIndex = '1000';
  suggestionBox.style.display = 'none';
  suggestionBox.style.maxHeight = '120px';
  suggestionBox.style.overflowY = 'auto';
  input.parentNode.style.position = 'relative';
  input.parentNode.appendChild(suggestionBox);

  input.addEventListener('input', () => {
    const value = input.value.toLowerCase();
    const jobs = JSON.parse(localStorage.getItem('jobFileHistory') || '[]');
    const suggestions = [...new Set(jobs.map(j => j[type]).filter(v => v && v.toLowerCase().includes(value)))];
    if (suggestions.length > 0 && value.length > 0) {
      suggestionBox.innerHTML = suggestions.map(s => `<div class='p-1 hover:bg-gray-100 cursor-pointer'>${s}</div>`).join('');
      suggestionBox.style.display = 'block';
      Array.from(suggestionBox.children).forEach(div => {
        div.addEventListener('click', () => {
          input.value = div.textContent;
          suggestionBox.style.display = 'none';
        });
      });
    } else {
      suggestionBox.style.display = 'none';
    }
  });

  document.addEventListener('click', (e) => {
    if (!input.parentNode.contains(e.target)) suggestionBox.style.display = 'none';
  });
}
</script>
<!-- === SMART AUTO-FILL & MEMORY SYSTEM END === -->
<!-- === ADVANCED OFFLINE ANALYTICS SYSTEM START === -->
<script>
// Save extended job data for analytics
const originalSave = saveData;
saveData = function() {
  originalSave();
  const data = getFormData();
  const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
  const totals = {
    cost: document.getElementById('total-cost').textContent || 0,
    selling: document.getElementById('total-selling').textContent || 0,
    profit: document.getElementById('total-profit').textContent || 0
  };
  const jobEntry = {
    date: data.d || new Date().toISOString().slice(0,10),
    shipper: data.sh,
    consignee: data.co,
    charges: data.ch,
    totalCost: parseFloat(totals.cost),
    totalSelling: parseFloat(totals.selling),
    totalProfit: parseFloat(totals.profit)
  };
  jobs.push(jobEntry);
  localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

};

// Advanced AI Dashboard with monthly/yearly breakdown


  const totalJobs = jobs.length;
  const totalProfit = jobs.reduce((acc,j)=>acc+j.totalProfit,0);
  const totalCost = jobs.reduce((acc,j)=>acc+j.totalCost,0);
  const totalSelling = jobs.reduce((acc,j)=>acc+j.totalSelling,0);

  // Charges breakdown
  const chargeTotals = {};
  jobs.forEach(job => {
    job.charges.forEach(c => {
      if (!chargeTotals[c.l]) chargeTotals[c.l]=0;
      chargeTotals[c.l]+= parseFloat(c.c||0);
    });
  });

  // Monthly stats
  const monthly = {};
  jobs.forEach(job => {
    const month = job.date.slice(0,7); // YYYY-MM
    if (!monthly[month]) monthly[month] = {profit:0,cost:0,selling:0,count:0};
    monthly[month].profit += job.totalProfit;
    monthly[month].cost += job.totalCost;
    monthly[month].selling += job.totalSelling;
    monthly[month].count += 1;
  });

  // Yearly stats
  const yearly = {};
  jobs.forEach(job => {
    const year = job.date.slice(0,4);
    if (!yearly[year]) yearly[year] = {profit:0,cost:0,selling:0,count:0};
    yearly[year].profit += job.totalProfit;
    yearly[year].cost += job.totalCost;
    yearly[year].selling += job.totalSelling;
    yearly[year].count += 1;
  });

  let html = `<h3 class='font-bold text-lg mb-2'>📊 Advanced Offline Analytics</h3>`;
  html += `<p><strong>Total Jobs:</strong> ${totalJobs}</p>`;
  html += `<p><strong>Total Profit:</strong> $${totalProfit.toFixed(2)}</p>`;
  html += `<p><strong>Total Cost:</strong> $${totalCost.toFixed(2)}</p>`;
  html += `<p><strong>Total Selling:</strong> $${totalSelling.toFixed(2)}</p>`;

  html += `<h4 class='font-bold mt-3'>Charges Breakdown</h4><ul>`;
  for (let key in chargeTotals) {
    html += `<li>${key}: $${chargeTotals[key].toFixed(2)}</li>`;
  }
  html += `</ul>`;

  html += `<h4 class='font-bold mt-3'>Monthly Summary</h4><ul>`;
  for (let m in monthly) {
    html += `<li>${m}: Jobs ${monthly[m].count}, Profit $${monthly[m].profit.toFixed(2)}</li>`;
  }
  html += `</ul>`;

  html += `<h4 class='font-bold mt-3'>Yearly Summary</h4><ul>`;
  for (let y in yearly) {
    html += `<li>${y}: Jobs ${yearly[y].count}, Profit $${yearly[y].profit.toFixed(2)}</li>`;
  }
  html += `</ul>`;

  html += `<button onclick="downloadAnalytics()" class="bg-blue-500 text-white px-3 py-1 rounded mt-2">Download Full Report (CSV)</button>`;

  showModal(html);
}

// Download analytics as CSV
function downloadAnalytics() {
  const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
  let csv = "Date,Shipper,Consignee,Total Cost,Total Selling,Total Profit\n";
  jobs.forEach(j => {
    csv += `${j.date},${j.shipper},${j.consignee},${j.totalCost},${j.totalSelling},${j.totalProfit}\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = "job_analytics_report.csv";
  link.click();
}
</script>
<!-- === ADVANCED OFFLINE ANALYTICS SYSTEM END === -->
<!-- === FIXED AI DASHBOARD & SAMPLE DATA START === -->
<script>
// Hook into save button to ensure analytics data is recorded
// Removed duplicate analytics hook
saveData = function() {
  originalSaveDataFn();
  // recordJobForAnalytics removed to prevent duplicates
};

// Record job into analytics
function recordJobForAnalytics() {
  const data = getFormData();
  const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
  const totals = {
    cost: parseFloat(document.getElementById('total-cost')?.textContent || 0),
    selling: parseFloat(document.getElementById('total-selling')?.textContent || 0),
    profit: parseFloat(document.getElementById('total-profit')?.textContent || 0)
  };
  const jobEntry = {
    date: new Date().toISOString().slice(0,10),
    shipper: data.sh || "Unknown Shipper",
    consignee: data.co || "Unknown Consignee",
    charges: data.ch || [],
    totalCost: totals.cost,
    totalSelling: totals.selling,
    totalProfit: totals.profit
  };
  jobs.push(jobEntry);
  localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

}

// Add sample data if none exists (for first run demo)
document.addEventListener('DOMContentLoaded', () => {
  let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
  if (jobs.length === 0) {
    jobs = [
      {date:"2025-07-01",shipper:"ABC Logistics",consignee:"XYZ Imports",charges:[{l:"Labour",c:50}],totalCost:200,totalSelling:300,totalProfit:100},
      {date:"2025-07-15",shipper:"Global Shipper",consignee:"Retail Hub",charges:[{l:"Transport",c:80}],totalCost:250,totalSelling:400,totalProfit:150},
      {date:"2025-08-01",shipper:"Ocean Freight",consignee:"Tech Store",charges:[{l:"Clearance",c:40}],totalCost:180,totalSelling:280,totalProfit:100}
    ];
    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

  }
});
</script>
<!-- === FIXED AI DASHBOARD & SAMPLE DATA END === -->
<div class="modal-overlay hidden" id="erp-modal">
<div class="modal-content w-full max-w-6xl">
<div class="flex justify-between items-center mb-4">
<h3 class="text-2xl font-bold">📊 ERP System Dashboard</h3>
<button class="text-gray-500 hover:text-gray-800 text-2xl" onclick="closeERPModal()">×</button>
</div>
<div class="space-y-6">
<div class="flex justify-between">
<div>
<div class="flex justify-between items-center mb-2">
<h4 class="font-bold">Job Database</h4>
<select class="input-field w-48" id="sort-option" onchange="loadERPData()">
<option value="newest">Sort by: Newest First</option>
<option value="oldest">Sort by: Oldest First</option>
<option value="profit-high">Sort by: Profit High → Low</option>
<option value="profit-low">Sort by: Profit Low → High</option>
<option value="az">Sort by: A–Z (Shipper)</option>
<option value="za">Sort by: Z–A (Shipper)</option>
</select>
</div>
<input class="input-field w-64 mb-2" id="job-search" placeholder="Search jobs..." type="text"/>
<div class="flex justify-between items-center mb-2">
<button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" onclick="clearAllJobs()">🗑️ Clear All Records</button>
</div>
<div class="border p-2 h-60 overflow-y-auto bg-gray-50 rounded" id="job-list"></div>
<button class="bg-indigo-500 text-white px-3 py-1 rounded mt-2" onclick="backupJobs()">Backup Jobs</button>
<input class="mt-2" id="restore-file-erp" onchange="restoreJobs(this)" type="file"/>
</div>
<div class="w-1/2">
<h4 class="font-bold">Analytics</h4>
<canvas class="bg-white border rounded p-2" id="analytics-chart"></canvas>
</div>
</div>
<div>
<h4 class="font-bold">Attachments</h4>
<input class="mb-2" id="attachment-upload" multiple="" type="file"/>
<div class="grid grid-cols-4 gap-2" id="attachment-list"></div>
</div>
</div>
<div class="mt-4 text-center">
<button class="bg-red-500 text-white px-4 py-2 rounded" onclick="closeERPModal()">⬅ Back</button>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        function openERPModal() {
            document.getElementById('erp-modal').classList.remove('hidden');
            loadERPData();
        }
        function closeERPModal() {
            document.getElementById('erp-modal').classList.add('hidden');
        }

        function loadERPData() {
            const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
            const jobList = document.getElementById('job-list');
            jobList.innerHTML = jobs.map(j => `<div class='p-1 border-b'>${j.date} - ${j.shipper} → ${j.consignee} | Profit: $${j.totalProfit.toFixed(2)}</div>`).join('');

            const ctx = document.getElementById('analytics-chart').getContext('2d');
            const monthlyData = {};
            jobs.forEach(j => {
                const m = j.date.slice(0,7);
                if (!monthlyData[m]) monthlyData[m] = 0;
                monthlyData[m] += j.totalProfit;
            });
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'Monthly Profit',
                        data: Object.values(monthlyData),
                        backgroundColor: '#10b981'
                    }]
                }
            });
        }
    </script>
<script>
// === File Management System ===

// Save job with duplicate check
const originalSaveFn = saveData;
saveData = function() {
    const data = getFormData();
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const jobIndex = jobs.findIndex(j => j.jobFileNo === data.jfn);

    const totals = {
        cost: parseFloat(document.getElementById('total-cost')?.textContent || 0),
        selling: parseFloat(document.getElementById('total-selling')?.textContent || 0),
        profit: parseFloat(document.getElementById('total-profit')?.textContent || 0)
    };

    const jobEntry = {
        jobFileNo: data.jfn || "No-Job-File",
        date: data.d || new Date().toISOString().slice(0,10),
        shipper: data.sh,
        consignee: data.co,
        charges: data.ch,
        totalCost: totals.cost,
        totalSelling: totals.selling,
        totalProfit: totals.profit,
        fullData: data
    };

    if (jobIndex >= 0) {
        jobs[jobIndex] = jobEntry; // Update existing job
    } else {
        jobs.push(jobEntry); // Add new job
    }

    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    originalSaveFn();
    alert('✅ Job File saved successfully!');
};

// Load File Management Table
function loadERPData() {
    const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const jobList = document.getElementById('job-list');
    if (!jobs.length) {
        jobList.innerHTML = "<p class='text-gray-500'>No Job Files saved yet.</p>";
        return;
    }
    jobList.innerHTML = jobs.map((j, i) => `
        <div class='p-2 border-b flex justify-between items-center'>
            <div>
                <strong>${j.jobFileNo}</strong> - ${j.date}<br>
                ${j.shipper} → ${j.consignee} | Profit: $${j.totalProfit.toFixed(2)}
            </div>
            <div class='space-x-2'>
                <button onclick="previewJobIndex($i)" class='bg-blue-500 text-white px-2 py-1 rounded'>Preview</button>
                <button onclick="editJob('${j.jobFileNo}')" class='bg-green-500 text-white px-2 py-1 rounded'>Edit</button>
                <button onclick="deleteJob('${j.jobFileNo}')" class='bg-red-500 text-white px-2 py-1 rounded'>Delete</button>
            </div>
        </div>
    `).join('');
    loadAnalyticsChart(jobs);
}

// Edit job
function editJob(jobFileNo) {
    const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const job = jobs.find(j => j.jobFileNo === jobFileNo);
    if (!job) return alert('Job not found!');
    closeERPModal();
    populateFormFromData(job.fullData);
    alert('✅ Job File loaded for editing.');
}

// Delete job
function deleteJob(jobFileNo) {
    if (!confirm('Are you sure you want to delete this Job File?')) return;
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    jobs = jobs.filter(j => j.jobFileNo !== jobFileNo);
    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    loadERPData();
    alert('🗑️ Job File deleted.');
}

// Load analytics chart
function loadAnalyticsChart(jobs) {
    const ctx = document.getElementById('analytics-chart').getContext('2d');
    const monthlyData = {};
    jobs.forEach(j => {
        const m = j.date.slice(0,7);
        if (!monthlyData[m]) monthlyData[m] = 0;
        monthlyData[m] += j.totalProfit;
    });
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(monthlyData),
            datasets: [{
                label: 'Monthly Profit',
                data: Object.values(monthlyData),
                backgroundColor: '#10b981'
            }]
        }
    });
}
</script>
<script>
// Enhanced loadERPData with sorting and live delete fix
function loadERPData() {
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const sortOption = document.getElementById('sort-option')?.value || 'newest';

    // Sorting logic
    jobs.sort((a,b) => {
        if (sortOption === 'newest') return new Date(b.date) - new Date(a.date);
        if (sortOption === 'oldest') return new Date(a.date) - new Date(b.date);
        if (sortOption === 'profit-high') return b.totalProfit - a.totalProfit;
        if (sortOption === 'profit-low') return a.totalProfit - b.totalProfit;
        if (sortOption === 'az') return (a.shipper || '').localeCompare(b.shipper || '');
        if (sortOption === 'za') return (b.shipper || '').localeCompare(a.shipper || '');
        return 0;
    });

    const jobList = document.getElementById('job-list');
    if (!jobs.length) {
        jobList.innerHTML = "<p class='text-gray-500'>No Job Files saved yet.</p>";
        return;
    }
    jobList.innerHTML = jobs.map(j => `
        <div class='p-2 border-b flex justify-between items-center'>
            <div>
                <strong>${j.jobFileNo}</strong> - ${j.date}<br>
                ${j.shipper} → ${j.consignee} | Profit: $${j.totalProfit.toFixed(2)}
            </div>
            <div class='space-x-2'>
                <button onclick="previewJobIndex($i)" class='bg-blue-500 text-white px-2 py-1 rounded'>Preview</button>
                <button onclick="editJob('${j.jobFileNo}')" class='bg-green-500 text-white px-2 py-1 rounded'>Edit</button>
                <button onclick="deleteJob('${j.jobFileNo}')" class='bg-red-500 text-white px-2 py-1 rounded'>Delete</button>
            </div>
        </div>
    `).join('');
    loadAnalyticsChart(jobs);
}

function deleteJob(jobFileNo) {
    if (!confirm('Are you sure you want to delete this Job File?')) return;
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    jobs = jobs.filter(j => j.jobFileNo !== jobFileNo);
    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    loadERPData(); // Live refresh
    alert('🗑️ Job File deleted successfully.');
}
</script>
<script>
function clearAllJobs() {
    if (!confirm('⚠️ Are you sure you want to delete ALL job records? This cannot be undone.')) return;
    localStorage.removeItem('jobAnalytics');
    localStorage.removeItem('jobFileData');
    document.getElementById('job-list').innerHTML = "<p class='text-gray-500'>All job records have been cleared.</p>";
    alert('✅ All job records deleted.');
}
</script>
<script>
// Ensure no double save - single function handles saving with duplicate check
const baseSave = saveData;
saveData = function() {
    const data = getFormData();
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const jobIndex = jobs.findIndex(j => j.jobFileNo === data.jfn);

    const totals = {
        cost: parseFloat(document.getElementById('total-cost')?.textContent || 0),
        selling: parseFloat(document.getElementById('total-selling')?.textContent || 0),
        profit: parseFloat(document.getElementById('total-profit')?.textContent || 0)
    };

    const jobEntry = {
        jobFileNo: data.jfn || "No-Job-File",
        date: data.d || new Date().toISOString().slice(0,10),
        shipper: data.sh,
        consignee: data.co,
        charges: data.ch,
        totalCost: totals.cost,
        totalSelling: totals.selling,
        totalProfit: totals.profit,
        fullData: data
    };

    if (jobIndex >= 0) {
        jobs[jobIndex] = jobEntry; // Update existing job
    } else {
        jobs.push(jobEntry); // Add new job
    }

    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    baseSave(); // Call original save logic for form data
    alert('✅ Job File saved successfully without duplicates!');
};
</script>
<script>
function generateJobFileID() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const rand = Math.floor(Math.random()*1000).toString().padStart(3,'0');
    return `JF-${y}${m}${d}-${rand}`;
}

// Overwrite saveData to fix duplicate & blank Job File No
const origSave = saveData;
saveData = function() {
    const data = getFormData();
    if (!data.jfn || data.jfn.trim() === "") {
        data.jfn = generateJobFileID();
        document.getElementById('job-file-no').value = data.jfn;
    }

    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const jobIndex = jobs.findIndex(j => j.jobFileNo === data.jfn);

    const totals = {
        cost: parseFloat(document.getElementById('total-cost')?.textContent || 0),
        selling: parseFloat(document.getElementById('total-selling')?.textContent || 0),
        profit: parseFloat(document.getElementById('total-profit')?.textContent || 0)
    };

    const jobEntry = {
        jobFileNo: data.jfn,
        date: data.d || new Date().toISOString().slice(0,10),
        shipper: data.sh,
        consignee: data.co,
        charges: data.ch,
        totalCost: totals.cost,
        totalSelling: totals.selling,
        totalProfit: totals.profit,
        fullData: data
    };

    if (jobIndex >= 0) {
        jobs[jobIndex] = jobEntry; // Update existing
    } else {
        jobs.push(jobEntry); // Add new
    }

    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));

    // === Save Success Popup ===
    const popup = document.createElement('div');
    popup.textContent = '✅ Job File Saved Successfully!';
    popup.style.position = 'fixed';
    popup.style.top = '20px';
    popup.style.right = '20px';
    popup.style.background = '#10b981';
    popup.style.color = 'white';
    popup.style.padding = '12px 20px';
    popup.style.borderRadius = '8px';
    popup.style.fontWeight = 'bold';
    popup.style.zIndex = '9999';
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2000);

    origSave();
    alert('✅ Job File saved successfully (No duplicates).');
};
</script>
<script>
// Success Popup
function showSavePopup() {
    const popup = document.getElementById('save-popup');
    popup.style.display = 'block';
    setTimeout(() => popup.style.display = 'none', 2000);
}

// Override saveData to include popup
const oldSave = saveData;
saveData = function() {
    oldSave();
    showSavePopup();
};

// Preview Job Function
function previewJob(jobFileNo) {
    const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    const job = jobs.find(j => j.jobFileNo === jobFileNo);
    if (!job) return alert('Job not found for preview!');
    populateFormFromData(job.fullData);
    closeERPModal();
    openPreviewModal(); // Calls existing main preview
}
</script>
<script>
function previewJobIndex(index) {
    const jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    if (!jobs[index]) return alert('❌ Job not found!');
    const job = jobs[index];

    // Load job into form
    populateFormFromData(job.fullData);
    closeERPModal();

    // Universal approach: fire the same event as manual Preview click
    setTimeout(() => {
        // Find any element with "Preview" text or id and dispatch click
        const candidates = Array.from(document.querySelectorAll("button, a, div"));
        let previewElement = candidates.find(el => el.innerText && el.innerText.trim().toLowerCase() === "preview");

        if (!previewElement) {
            // Try ID-based search
            previewElement = document.getElementById("preview") || document.getElementById("previewBtn");
        }

        if (previewElement) {
            const event = new MouseEvent('click', { bubbles: true, cancelable: true });
            previewElement.dispatchEvent(event);
        } else {
            alert('❌ Preview element not found on main page!');
        }
    }, 400);
}
</script>
<script>
const DELETE_PASSWORD = "1234";

function deleteJob(jobFileNo) {
    const input = prompt("Enter password to delete this job:");
    if (input !== DELETE_PASSWORD) {
        alert("❌ Wrong password! Action cancelled.");
        return;
    }
    let jobs = JSON.parse(localStorage.getItem('jobAnalytics') || '[]');
    jobs = jobs.filter(j => j.jobFileNo !== jobFileNo);
    localStorage.setItem('jobAnalytics', JSON.stringify(jobs));
    loadERPData();
    alert('🗑️ Job File deleted.');
}

function clearAllJobs() {
    const input = prompt("Enter password to clear ALL records:");
    if (input !== DELETE_PASSWORD) {
        alert("❌ Wrong password! Action cancelled.");
        return;
    }
    localStorage.removeItem('jobAnalytics');
    localStorage.removeItem('jobFileData');
    document.getElementById('job-list').innerHTML = "<p class='text-gray-500'>All job records have been cleared.</p>";
    alert('✅ All job records deleted.');
}
</script>

<script>
// === SAFE OFFLINE OVERRIDE ===

// Override Remark Generator to work offline
if (typeof generateRemarks === 'function') {
    generateRemarks = function() {
        showLoader();
        const data = getFormData();
        const remark = `Shipment from ${data.or || 'Origin'} to ${data.de || 'Destination'} for ${data.sh || 'Shipper'} and ${data.co || 'Consignee'} processed successfully.`;
        document.getElementById('remarks').value = remark;
        hideLoader();
    }
}

// Override Cost Analyzer to work offline
if (typeof analyzeCosts === 'function') {
    analyzeCosts = function() {
        showLoader();
        const data = getFormData();
        if (data.ch.length === 0) {
            showModal("<p class='text-red-500'>⚠️ Please enter some costs before analyzing.</p>");
            hideLoader();
            return;
        }
        let totalProfit = 0;
        let analysis = "<h3 class='font-bold mb-2'>📊 Offline Cost Analysis</h3><ul>";
        data.ch.forEach(c => {
            const cost = parseFloat(c.c || 0);
            const selling = parseFloat(c.s || 0);
            const profit = selling - cost;
            totalProfit += profit;
            let status = profit < 0 ? "🔴 Loss" : (profit < 50 ? "🟠 Low Margin" : "🟢 Good");
            analysis += `<li>${c.l}: Cost $${cost.toFixed(2)}, Selling $${selling.toFixed(2)}, Profit $${profit.toFixed(2)} (${status})</li>`;
        });
        analysis += "</ul>";
        analysis += `<p><strong>Total Profit:</strong> $${totalProfit.toFixed(2)}</p>`;
        showModal(analysis);
        hideLoader();
    }
}
</script>
</body>
</html>

</div>

<script>
// Temporary static user list for testing
const users = [
  { username: "akif", password: "1234", displayName: "Akif Arif Bade" },
  { username: "natasha", password: "5678", displayName: "Natasha Aysha" }
];

function performLogin() {
    const uname = document.getElementById('login-username').value.trim();
    const pass = document.getElementById('login-password').value.trim();
    const user = users.find(u => u.username===uname && u.password===pass);
    if(user) {
        console.log("✅ Login successful for", uname);
        document.getElementById('login-screen').style.display='none';
        document.getElementById('main-container').style.display='block';
        let prepField = document.getElementById('prepared-by');
        if(prepField) {
            prepField.value = user.displayName;
            prepField.readOnly = true;
        }
    } else {
        document.getElementById('login-error').innerText = 'Invalid username or password';
    }
}
</script>

</body>
</html>
